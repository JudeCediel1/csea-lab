% complex demodulationfunction[demodmat, phasemat]=compdemod_mul(filemat, targetfreq, bslvec);for index = 1:size(filemat,1);          demodmat = [];         atgPath = deblank(filemat(index,:));	    [AvgMat, dummy, samp_int] = read_mul(atgPath);         if size(AvgMat,2) == 1700, AvgMat = AvgMat(:,1:2:1700);samp_int = samp_int *2; end        SampRate = 1000/samp_int;		taxis = 0:1000/SampRate:size(AvgMat,2)*1000/SampRate - 1000/SampRate;	taxis = taxis/1000;     	M2 = 75;	squarecos1 = (cos(pi/2:(pi-pi/2)/M2:pi-(pi-pi/2)/M2)).^2;		squarecosfunction = [squarecos1 ones(1,length(taxis)-length(squarecos1).*2) fliplr(squarecos1)];		size(squarecosfunction);	    [B, A] = butter(3, 0.0065);    	%[B, A] = butter(3, 0.0065);  % OK filter		for channel = 1:size(AvgMat,1)	        Xsin(channel,:) = AvgMat(channel,:) .* squarecosfunction .* sin(targetfreq .*2 *pi * taxis);        Xcos(channel,:) = AvgMat(channel,:) .* squarecosfunction .* cos(targetfreq .*2 *pi * taxis);	           XsinF(channel,:) = filtfilt(B,A,Xsin(channel,:));         XcosF(channel,:) = filtfilt(B,A,Xcos(channel,:));      end        %     plot(XsinF(118,:)), pause (2)%      plot(XcosF(118,:)), pause (2)		demodmat = 2 * sqrt(XsinF .^2 + XcosF .^2);        plot(taxis, demodmat(40,:)), grid    pause(1)    %     [D, C] = butter(5, 0.1);%     %     xf = filtfilt(D,C,demodmat'); %     %     [B,A] = butter(5,0.0025,'high')%     %     xf = filtfilt(B,A,xf); %     %     demodmat = xf';      if ~isempty(bslvec);         demodmat = bslcorr(demodmat, bslvec);    end        %demodmat = demodmat(:,1:2:size(demodmat,2));  %downsampling ?    	phasemat = atan(XsinF ./ XcosF); 		eval(['save ' deblank(atgPath) '.amp demodmat -ascii'])    %eval(['save ' deblank(atgPath) '.pha phasemat -ascii'])end