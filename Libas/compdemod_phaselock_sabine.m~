% complex demodulationfunction[phaselockmat_left]=compdemod_phaselock_sabine(filemat, targetfreq, bslvec);pairmat_left = [ones(129,1)*65 (1:129)'];pairmat_right = [ones(129,1)*91 (1:129)'];for fileindex = 1: size(filemat,1);     atgPath = filemat(fileindex, :);     [AvgMat,File,Path,FilePath,NTrialAvgVec,StdChanTimeMat,...	SampRate,AvgRef,Version,MedMedRawVec,MedMedAvgVec,EegMegStatus,...    NChanExtra,TrigPoint,HybridFactor,HybridDataCell] = ReadAvgFile(atgPath);     taxis = 0:1000/SampRate:size(AvgMat,2)*1000/SampRate - 1000/SampRate;	taxis = taxis/1000;     	M2 = 150;	squarecos1 = (cos(pi/2:(pi-pi/2)/M2:pi-(pi-pi/2)/M2)).^2;		squarecosfunction = [squarecos1 ones(1,length(taxis)-length(squarecos1).*2) fliplr(squarecos1)];		size(squarecosfunction)		[B, A] = butter(5, 0.4);		for channel = 1:size(AvgMat,1)	        Xsin(channel,:) = AvgMat(channel,:) .* squarecosfunction .* sin(targetfreq .*2 *pi * taxis);        Xcos(channel,:) = AvgMat(channel,:) .* squarecosfunction .* cos(targetfreq .*2 *pi * taxis);	            XsinF(channel,:) = filtfilt(B,A,Xsin(channel,:));        XcosF(channel,:) = filtfilt(B,A,Xcos(channel,:));            end	    % phaselock        comptseries = (XsinF + i*XcosF);    comptseries = comptseries ./ abs(comptseries);    for pair = 1 : size(pairmat_left,1)	        for twinstart = 1 : length(AvgMat(1,:)) -60		            diffvec_left = sum(comptseries(pairmat_left(pair,:), twinstart:twinstart+59));            diffvec_right = sum(comptseries(pairmat_right(pair,:), twinstart:twinstart+59));			            phaselockmat_left(pair,twinstart) = sum(abs(diffvec_left))./120;                    end    end        	demodmat = 2 * sqrt(XsinF .^2 + XcosF .^2);        [B, A] = butter(5, 0.08);        xf = filtfilt(B,A,demodmat');         [B,A] = butter(5,0.0025,'high');        xf = filtfilt(B,A,xf);         demodmat = xf';      if ~isempty(bslvec);         demodmat = bslcorr(demodmat, bslvec);    end    	phasemat = atan(XsinF ./ XcosF); 	    	eval(['save ' deblank(atgPath) '.amp demodmat -ascii'])    eval(['save ' deblank(atgPath) '.pha phasemat -ascii'])    eval(['save ' deblank(atgPath) '.coh phaselockmat_left -ascii'])end