function[SetFilePath,ParaVec,MEGSensorPosMat,EEGSensorPosMat,MEGSensorNameVec,EEGSensorNameVec,MEGSensorIndexVec,EEGSensorIndexVec,MsiFormat]=ReadMsiSet_as(SetFilePath)%==================================================================%%	ReadMsiSet.m%%	Markus Junghoefer	[2000]%%%	%	Function definition	%=================================================================if nargin<1; SetFilePath=[];endParaVec=[];MEGSensorPosMat=[];EEGSensorPosMat=[];MEGSensorNameVec=[];EEGSensorNameVec=[];MEGSensorIndexVec=[];EEGSensorIndexVec=[];File=[];Path=[];String='Choose MSI set file:';[DefPath]=SetDefPath(1,'*.set');[SetFile,SetPath,SetFilePath]=ReadFilePath(SetFilePath,DefPath,String);SetDefPath(2,SetPath);if SetFile==0; MsiFilePath=[]; return; endif exist(SetFilePath,'file')~=2	Message=char('Sorry,');	Message=char(Message,'unable to find MSI set file:');	Message=char(Message,'');	Message=char(Message,[SetFilePath]);	Message=char(Message,'');	hmsgbox=msgbox(Message,'Info','help'); 	return;endKeyWordMat=char('MSI.TotalChannels:');KeyWordMat=char(KeyWordMat,'MSI.TotalSlices:');KeyWordMat=char(KeyWordMat,'MSI.TotalEpochs:');KeyWordMat=char(KeyWordMat,'MSI.SigAChanCount:');KeyWordMat=char(KeyWordMat,'MSI.SampleFrequency:');KeyWordMat=char(KeyWordMat,'MSI.SamplePeriod:');KeyWordMat=char(KeyWordMat,'MSI.FirstLatency:');KeyWordMat=char(KeyWordMat,'MSI.EEGChanCount:');KeyWordMat=char(KeyWordMat,'MSI.SlicesPerEpoch:');KeyWordFormat=['d','d','d','d','f','f','f','d','d'];NKeyWord=size(KeyWordMat,1);ParaVec=zeros(NKeyWord,1);SetFid=fopen(SetFilePath,'rt');while feof(SetFid) == 0   	Line=fgetl(SetFid);	for KeyWordInd=1:NKeyWord		Keyword=deblank(KeyWordMat(KeyWordInd,:));		Matches=findstr(Line,Keyword);		TestLine=sprintf(['%s\t%%',KeyWordFormat(KeyWordInd)],Keyword);		Num=length(Matches);		if Num>0	    	ParaVec(KeyWordInd)=sscanf(Line,TestLine,1);		end	endendfrewind(SetFid);NTotChan=ParaVec(1);NPoints=ParaVec(2);NTrials=ParaVec(3);NMegChan=ParaVec(4);SampRate=ParaVec(5);SampPeriod=ParaVec(6);BaseMs=ParaVec(7);NEegChan=ParaVec(8);NpointsEpoch=ParaVec(9);%================Read MSI FormatKeyword='MSI.Format:';MsiFormat='FLOAT';while feof(SetFid) == 0   	Line=fgetl(SetFid);	Matches=findstr(Line,Keyword);	TestLine=sprintf(['%s\t%%','s'],Keyword);	Num=length(Matches);	if Num>0	    MsiFormat=sscanf(Line,TestLine,1);	endendMsiFormat=lower(MsiFormat);frewind(SetFid);%================Read MEG SensorIndexVecfrewind(SetFid);KeyWord='MSI.SigAChanIndex:';MEGSensorIndexVec=zeros(NMegChan,1);while feof(SetFid) == 0   	Line=fgetl(SetFid);	Matches=findstr(Line,KeyWord);	Num=length(Matches);	if Num>0		Index=1;		%================eat up IndexLine	   	Remainder=Line(Matches(1)+length(KeyWord):length(Line));	   	while(any(Remainder));			[Chopped,Remainder]=strtok(Remainder,',');			Tmp=sscanf(Chopped,'%d');			MEGSensorIndexVec(Index)=Tmp+1;			Index=Index+1;	    end	endend%================Read MEG MEGSensorNameVecfrewind(SetFid);KeyWord='MSI.SigAChanNames:';MEGSensorNameVec=[];while feof(SetFid) == 0   	Line=fgetl(SetFid);	Matches=findstr(Line,KeyWord);	Num=length(Matches);	if Num>0		Index=1;		%================eat up IndexLine	   	Remainder=Line(Matches(1)+length(KeyWord):length(Line));	   	while(any(Remainder));			[Chopped,Remainder]=strtok(Remainder,',');			MEGSensorNameVec=char(MEGSensorNameVec,Chopped);			Index=Index+1;	    end	endend%================Read EEG SensorIndexVecfrewind(SetFid);KeyWord='MSI.EEGChanIndex:';EEGSensorIndexVec=zeros(NEegChan,1);while feof(SetFid) == 0   	Line=fgetl(SetFid);	Matches=findstr(Line,KeyWord);	Num=length(Matches);	if Num>0		Index=1;		%================eat up IndexLine	   	Remainder=Line(Matches(1)+length(KeyWord):length(Line));	   	while(any(Remainder));			[Chopped,Remainder]=strtok(Remainder,',');			Tmp=sscanf(Chopped,'%d');			EEGSensorIndexVec(Index)=Tmp+1;			Index=Index+1;	    end	endend%================Read EEGSensorNameVecfrewind(SetFid);KeyWord='MSI.EEGChanNames:';EEGSensorNameVec=[];while feof(SetFid) == 0   	Line=fgetl(SetFid);	Matches=findstr(Line,KeyWord);	Num=length(Matches);	if Num>0		Index=1;		%================eat up IndexLine	   	Remainder=Line(Matches(1)+length(KeyWord):length(Line));	   	while(any(Remainder));			[Chopped,Remainder]=strtok(Remainder,',');			EEGSensorNameVec=char(EEGSensorNameVec,Chopped);			Index=Index+1;	    end	endend%================Read MEG Sensor Position and Orientation Matrixfrewind(SetFid);KeyWord='MSI.Position_Information.Begin:';MEGSensorNameVec=[];MEGSensorPosMat=zeros(NMegChan,6);while feof(SetFid) == 0   	Line=fgetl(SetFid);	Matches=findstr(Line,KeyWord);	Num=length(Matches);	if Num>0		for ChanInd=1:NMegChan			Line=fgetl(SetFid);			SpaceVec=isspace(Line);			LineTmp=[];			for i=1:length(SpaceVec)				if ~SpaceVec(i)					LineTmp=char(LineTmp,Line(i));				else					if ~SpaceVec(i-1)						LineTmp=char(LineTmp,' ');					end				end			end			LineTmp=deblank(LineTmp');			[Chopped,Remainder]=strtok(LineTmp,' ');			MEGSensorNameVec=char(MEGSensorNameVec,Chopped);			Index=1;			% eat up IndexLine	   		while(any(Remainder));				[Chopped,Remainder]=strtok(Remainder,' ');				Tmp=sscanf(Chopped,'%f');				MEGSensorPosMat(ChanInd,Index)=Tmp;				Index=Index+1;			end	    end	endendfclose(SetFid);Duration=SampPeriod.*NPoints;fprintf(1,'Total number of sensors:	%g\n', 	NTotChan);fprintf(1,'Number of total points: 			%g\n',  NPoints);fprintf(1,'Number of trials: 			%g\n',  NTrials);fprintf(1,'Number of MEG sensors: 		%g\n', 	NMegChan);fprintf(1,'Number of EEG sensors: 		%g\n', 	NEegChan);fprintf(1,'Sampling Rate [Hz]: 		%g\n',  	SampRate);fprintf(1,'Sampling Period [ms]: 		%g\n',  SampPeriod);fprintf(1,'First Latency [ms]:		%g\n',  	BaseMs);fprintf(1,'Duration [ms]: 				%g\n', Duration);fprintf(1,'Number of points in Epoch: 		%g\n', NpointsEpoch);fprintf(1,['File format: 				',MsiFormat]);return;