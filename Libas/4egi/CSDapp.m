% CSDapp% konvertiert appfiles in CSD Daten% %function[] = CSDapp(FilePath)disp('  preliminary version ')%if nargin == 0[Data,AppVersion,LAppHeader,ScaleBins,NChan,NPoints,NTrials,SampRate,ch_AvgRef,File,Path,FilePath] = readappdata;%endNewFilePath = [FilePath 'csd.app' ];% open new file for writeNewFid=fopen(NewFilePath,'w+');fwrite(NewFid,AppVersion,'int16');fwrite(NewFid,LAppHeader,'int16');fwrite(NewFid,ScaleBins,'int16');fwrite(NewFid,NChan,'int16');fwrite(NewFid,NPoints,'int16');fwrite(NewFid,NTrials,'int16');fwrite(NewFid,SampRate,'int16');fwrite(NewFid,ch_AvgRef,'int16');		AppTell=ftell(NewFid);ZeroVec=zeros(LAppHeader-AppTell,1);fwrite(NewFid,ZeroVec,'int8');% read coefficients and config filescd ..;cd ..;cd Plot2d3d;BasePath=pwd;CortMapVersion='2.0';CoeffPath=[BasePath,'Plot3dCoeff40'];LegPath=[BasePath,'Plot3dLegCoeff'];ECfgPath=[BasePath,'Plot2dUtil:ElectrodeCfg'];ECfgFile=['129.ecfg'];ECfgFilePath=[ECfgPath ':' ECfgFile];fid=fopen(ECfgFilePath,'r');fprintf('Start reading of file...\n\n');fprintf(ECfgFilePath)fprintf('\n\n');[AvgNChan,count] = fread(fid,1,'int16');	[ScalpRadius,count] = fread(fid,1,'float32');[TmpSpher,count]= fread(fid,[AvgNChan,2],'float32');fclose(fid);AllEPosSpher=zeros(AvgNChan,3);AllEPosSpher(:,1:2)=TmpSpher(1:AvgNChan,:);AllEPosSpher(:,3)=ScalpRadius.*ones(AvgNChan,1);AllEPosCart = change_sphere_cart(AllEPosSpher,ScalpRadius,1);[InvCoeff] = ReadOrCalcCoeff(1,AllEPosCart,AllEPosCart,LegPath,CoeffPath,ECfgFile,32,15, 0, 5001);[CsdCoeff] = ReadOrCalcCoeff(3,AllEPosCart,AllEPosCart,LegPath,CoeffPath,ECfgFile,32,15, 0, 5001);TmpVec=NTrialAvgVec-ones(1,AvgNChan);ChanStatusOffVec=find(TmpVec<=0);ChanStatusOnVec=find(TmpVec~=0);NChanStatusOn=length(ChanStatusOnVec);InvCoeff=InvCoeff(ChanStatusOnVec,ChanStatusOnVec);TmpStdMat=StdChanTimeMat(ChanStatusOnVec,:);[LambdaApprox]=IfEmptyInputVal(['Please insert the wished Lambda value of Approximation:'],[],[],0.02,1);for ChanInd=1:NChanStatusOn	InvCoeff(ChanInd,ChanInd)=InvCoeff(ChanInd,ChanInd).*LambdaApprox;endCsdMat=zeros(size(AvgMat));for trialInd = 1 : NTrials	[Data,Version,LHeader,ScaleBins,NChan,NPoints,NTrials,SampRate,ch_AvgRef,File,Path,FilePath] = readappdata(FilePath,trialInd);		for TimeInd=1:NPoints			DipStrength = InvCoeff \ AvgMat(ChanStatusOnVec,TimeInd);		CsdMat(:,TimeInd)=(DipStrength' * CsdCoeff)';	end		%SaveAppData(version,NewFid,FilePath,ScaleBins,NChan,NPoints,NTrials,trialInd,trialMat)endfclose all