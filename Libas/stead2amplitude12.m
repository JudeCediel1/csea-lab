%==================================================================%%	stead2amplitude%%%Caution:psdvec = max-min - irrefuehrender Vektorname%%	%	Function definition function [ampmat] = stead2amplitude12(filemat, plotflag, bslvec, ssvepvec);    if nargin < 2, plotflag = [], end   % this to be done outside the loop to save time, needed for winshift proc tempvec = [20 20 20 21 22 22]; % this makes sure that average win duration is exactly 17.8571, which is the duration in sp of one cyle at 14 Hz = 71.42 ms, sampled at 250 Hz longvec = repmat(tempvec,1,20); % repeat this many times, at leats for duration of entire epoch, subsegments are created later  winshiftvec_long = cumsum(longvec)+ ssvepvec(1); % use cumsum function to create growing vector of indices for start of the winshift tempindexvec = find(winshiftvec_long > ssvepvec(length(ssvepvec)));  endindex = tempindexvec(1);  % this is the first index for which the winshiftvector exceeds the data segment  winshiftvec = winshiftvec_long(1:endindex-5)for fileindex = 1 : size(filemat,1);    	FilePath = filemat(fileindex,:);   		[Data,Version,LHeader,ScaleBins,NChan,NPoints,NTrials,SampRate,AvgRefStatus,File,Path,FilePath,EegMegStatus,NChanExtra,AppFileFormatVal]=...	ReadAppData(FilePath,1);	    ampmat = [];     		for trial = 1:NTrials        [Data,Version,LHeader,ScaleBins,NChan,NPoints,NTrials,SampRate,AvgRefStatus,File,Path,FilePath,EegMegStatus,NChanExtra,AppFileFormatVal]=...	ReadAppData(FilePath,trial);       	%============================================================	% 2. Baseline correction	%===========================================================		disp ('subtracting baseline')	    datamat = bslcorr(Data, bslvec);	%===========================================================	% 3. moving window procedure with 4 cycles @ 14 Hz !!!	% 	%===========================================================	disp('moving window procedure')		winmatsum = zeros(size(datamat,1),84); %4 cycles of the given oscillation		if plotflag, h = figure, end           for winshiftstep = 1:length(winshiftvec)		        winmatsum = (winmatsum + regressionMAT(datamat(:,[winshiftvec(winshiftstep):winshiftvec(winshiftstep)+83])));                     if plotflag           subplot(2,1,2), plot(1:4:84*4, regressionMAT(datamat(:,[winshiftvec(winshiftstep):winshiftvec(winshiftstep)+83]))'), title(['sliding window starting at ' num2str((winshiftvec(winshiftstep))*4)  ' ms ']), xlabel('time in milliseconds')           subplot(2,1,1), plot(1:4:84*4, winmatsum'), title(['sum of sliding windows; number of shifts:' num2str(winshiftstep) ]), ylabel('microvolts')                      %  subplot(3,1,3), hold on, circle([0,0],1,200,'-');            %  plot([0;(imag(fouriercomp(120)./tenHZampfft(120)))], [0;(real(fouriercomp(120)./tenHZampfft(120)))]);title('phase angle of window')            pause(.4)       end          %    movmat(index) = getframe(h)     end        winmat = winmatsum./length(winshiftvec);       	%===========================================================	% 5. determine amplitude and Phase using fft	%===========================================================	disp ('determining 14 Hz Phase per channel')			% for fft with amplitude scaling:		NFFT = 84; 	NumUniquePts = ceil((NFFT+1)/2); 	fftMat = fft (winmat', 84);  % transpose: channels as columns (fft columnwise)	Mag = abs(fftMat);                                                   % Amplitude berechnen	Mag = Mag*2;   		Mag(1) = Mag(1)/2;                                                    % DC trat aber nicht doppelt auf	if ~rem(NFFT,2),                                                    % Nyquist Frequenz (falls vorhanden) auch nicht doppelt        Mag(length(Mag))=Mag(length(Mag))/2;	end		Mag=Mag/NFFT;     % FFT so skalieren, da? sie keine Funktion von NFFT ist        size(Mag)		fftamp = Mag(5,:);        ampmat = [ampmat fftamp'];         end % trials	% 	% 	%===========================================================% 	% 6. bestimmung der mittleren Amplitude mit diffferenz(max-min)% 	%===========================================================% 	% 	Phasevec = Phasevec';% 	tenHZampfft = tenHZampfft';% 	 	SaveAvgFile([FilePath '.STamp' ],ampmat,[],[],SampRate,[],[],EegMegStatus)%         % 	SaveAvgFile([FilePath '.win' ],winmat,NTrialAvgVec,[],SampRate,MedMedRawVec,MedMedAvgVec,EegMegStatus)%         % 	SaveAvgFile([FilePath '.pha' ],Phasevec,NTrialAvgVec,[],SampRate,MedMedRawVec,MedMedAvgVec,EegMegStatus)end