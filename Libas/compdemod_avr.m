% complex demodulationfunction[demodmat, phasemat]=compdemod_avr(filemat, targetfreq, bslvec, normflag);%% padding added !!!!! vorsicht!! if nargin < 4, normflag = 0; endfor index = 1:size(filemat,1);         atgPath = deblank(filemat(index,:));	   % [AvgMat,File,Path,FilePath,NTrialAvgVec,StdChanTimeMat,SampRate] = read_avr(atgPath);         [AvgMat, latencies, TSB, DI] = read_avr(atgPath);        if nargin > 2    AvgMat = bslcorr(AvgMat, bslvec);    end        % padding with noise at the beginning        AvgMat = [ fliplr(AvgMat(:,1:100)) AvgMat(:,1:100) fliplr(AvgMat(:,1:100))  AvgMat ]; 		taxis = 0:DI:size(AvgMat,2)*DI - DI;	taxis = taxis/1000;     	M2 = 100;    	squarecos1 = (cos(pi/2:(pi-pi/2)/M2:pi-(pi-pi/2)/M2)).^2;		squarecosfunction = [squarecos1 ones(1,length(taxis)-length(squarecos1).*2) fliplr(squarecos1)];		figure(1), plot(squarecosfunction) 	    %[B, A] = butter(3, 0.008);    	[B, A] = butter(6, 0.004);  % real filter for faces and IAPS		for channel = 1:size(AvgMat,1)	        Xsin(channel,:) = AvgMat(channel,:) .* squarecosfunction .* sin(targetfreq .*2 *pi * taxis);        Xcos(channel,:) = AvgMat(channel,:) .* squarecosfunction .* cos(targetfreq .*2 *pi * taxis);	           XsinF(channel,:) = filtfilt(B,A,Xsin(channel,:));         XcosF(channel,:) = filtfilt(B,A,Xcos(channel,:));      end        %     plot(XsinF(118,:)), pause (2)%      plot(XcosF(118,:)), pause (2)		demodmat = 2 * sqrt(XsinF .^2 + XcosF .^2);         % demodmat = demodmat(:,51:size(AvgMat,2));   %     [D, C] = butter(5, 0.1);%     %     xf = filtfilt(D,C,demodmat'); %     %     [B,A] = butter(5,0.0025,'high')%     %     xf = filtfilt(B,A,xf); %     %     demodmat = xf';      if ~isempty(bslvec) && normflag == 0;        demodmat = bslcorr(demodmat, bslvec);    elseif ~isempty(bslvec) && normflag == 1;        demodmat = bslcorr_div(demodmat, bslvec);    end     figure(3)      plot(demodmat(43,:).*5), title(atgPath), hold on, plot(AvgMat(43,:), 'r'),     pause(1)    hold off   %demodmat = demodmat .* 3;    	phasemat = atan(XsinF ./ XcosF); 		[File,Path,FilePath]=SaveAvgFile([atgPath '.amp'],demodmat,[],[], 1000/DI);    %eval(['save ' deblank(atgPath) '.pha phasemat -ascii'])end