function[OutFilePath]=MergeAvgFiles148(InFileMat,OutFilePath,chWeight,DefFileMask)%==================================================================%%	MergeAvgFiles.m%%	Markus Junghoefer	[1997]%%%	Function definition%%%%==================================================================if nargin<4; DefFileMask='*at*'; end;if nargin<3; chWeight=[]; end;if nargin<2; OutFilePath=[]; end;if nargin<1; InFileMat=[]; end;%==================================================================[DefFilePath] = SetDefPath(1,DefFileMask);[NFiles,InFileMat,NonUse,BatchFilePath]=ReadFileNames(InFileMat,DefFilePath,'Choose Avg files:');[BatchFile,BatchPath]=SepFilePath(BatchFilePath);SetDefPath(2,BatchPath);if NFiles==1; 	fprintf(1,'It does not make sense to merge only one file.\n');	fprintf(1,'Running file: MergeAvgFile');	return;elseif NFiles==0	fprintf(1,'Sorry, no file in InFileMat !\n'); 	fprintf(1,'Running file: MergeAvgFile');	return;endfprintf('\n\n');[chWeight]=IfEmptyInputSpecVal(chWeight,[1 2 3],2,...'Do you want to use',...'no weighting                [1]',...'trial number weighting      [2]',...'Std matrix weighting        [3]');OutFile=BatchFile;if length(OutFile)>4	if strcmp(OutFile(1:4),'Bat.')		OutFile=OutFile(5:length(OutFile));	endendif length(OutFile)>3	if strcmp(OutFile(1:3),'GM.')		OutFile=OutFile(4:length(OutFile));	endendif isempty(OutFilePath)	[OutFile,OutPath,OutFilePath]=WriteFilePath(['GM.w',int2str(chWeight),'.'OutFile],'Choose the new file name:');endif OutFile==0; fprintf(1,'Bad OutFilePath in MergeAvfFile !'); return; endif NFiles<2; return; endfor FileIndex=1:NFiles	[File,Path,FilePath]=GetFileNameOfMat(InFileMat,FileIndex);	[AvgMat,File,Path,FilePath,NTrialAvgVec,StdMat,...	SampRate,AvgRef,Version,MedMedRawVec,MedMedAvgVec,EegMegStatus,NChanExtra]=ReadAvgFile(FilePath);	AvgMat = AvgMat(1:148, :);	MedMedAvgVec = MedMedAvgVec(1:148);	MedMedRawVec = MedMedRawVec(1:148);		if FileIndex==1; 		[NChan,NPoints]=size(AvgMat);		if chWeight==1			MergeAvgMat=AvgMat;		elseif chWeight==2			MaxNumberOfTrials=max(NTrialAvgVec);			TotMaxNumberOfTrials=MaxNumberOfTrials;			MergeAvgMat=MaxNumberOfTrials.*AvgMat;		elseif chWeight==3			MergeAvgMat=AvgMat./StdMat; 			InvMergeStdMat=1./StdMat;		end		MergeStdMat=StdMat; 		MergeNTrialAvgVec=NTrialAvgVec;		MergeMedMedRawVec=MedMedRawVec;		MergeMedMedAvgVec=MedMedAvgVec;	else		if chWeight==1			MergeAvgMat=MergeAvgMat+AvgMat;		elseif chWeight==2			MaxNumberOfTrials=max(NTrialAvgVec);			TotMaxNumberOfTrials=TotMaxNumberOfTrials+MaxNumberOfTrials;			MergeAvgMat=MergeAvgMat+MaxNumberOfTrials.*AvgMat;		elseif chWeight==3			MergeAvgMat=MergeAvgMat+AvgMat./StdMat;			InvMergeStdMat=InvMergeStdMat+1./StdMat;		end		MergeStdMat=MergeStdMat+StdMat;		%============Falls MergeNTrialAvgVec=NTrialAvgVec'=============		SizeMergeNTrialAvgVec=size(MergeNTrialAvgVec);		SizeNTrialAvgVec=size(NTrialAvgVec);		if SizeMergeNTrialAvgVec(2)==SizeNTrialAvgVec(1); NTrialAvgVec=NTrialAvgVec'; end		%==============================================================% 		MergeNTrialAvgVec=MergeNTrialAvgVec+NTrialAvgVec;% 		MergeMedMedRawVec=MergeMedMedRawVec+MedMedRawVec;% 		MergeMedMedAvgVec=MergeMedMedAvgVec+MedMedAvgVec;		NMergeMedMedRawVec=length(MergeMedMedRawVec);		NMedMedRawVec=length(MedMedRawVec);		NTmpMedMedRaw=NMergeMedMedRawVec+NMedMedRawVec;		TmpMedMedRaw=zeros(NTmpMedMedRaw,1);		TmpMedMedRaw(1:NMergeMedMedRawVec)=MergeMedMedRawVec;		TmpMedMedRaw(NMergeMedMedRawVec+1:NTmpMedMedRaw)=MedMedRawVec;		MergeMedMedRawVec=TmpMedMedRaw;		NMergeMedMedAvgVec=length(MergeMedMedAvgVec);		NMedMedAvgVec=length(MedMedAvgVec);		NTmpMedMedAvg=NMergeMedMedAvgVec+NMedMedAvgVec;		TmpMedMedAvg=zeros(NTmpMedMedAvg,1);		TmpMedMedAvg(1:NMergeMedMedAvgVec)=MergeMedMedAvgVec;		TmpMedMedAvg(NMergeMedMedAvgVec+1:NTmpMedMedAvg)=MedMedAvgVec;		MergeMedMedAvgVec=TmpMedMedAvg;	endendif chWeight==1	MergeAvgMat=MergeAvgMat./NFiles;elseif chWeight==2	MergeAvgMat=MergeAvgMat./TotMaxNumberOfTrials;elseif chWeight==3	MergeAvgMat=MergeAvgMat./InvMergeStdMat;endMergeStdMat=MergeStdMat./NFiles;MergeMedMedRawVec=MergeMedMedRawVec./NFiles;MergeMedMedAvgVec=MergeMedMedAvgVec./NFiles;MergeAvgMat = [MergeAvgMat;rand(4, length(MergeAvgMat))];MergeMedMedAvgVec = [MedMedAvgVec; 0; 0; 0; 0];MergeMedMedRawVec = [MedMedRawVec; 0; 0; 0; 0];SaveAvgFile(OutFilePath,MergeAvgMat,MergeNTrialAvgVec,MergeStdMat,SampRate,MergeMedMedRawVec,MergeMedMedAvgVec,EegMegStatus,NChanExtra);return;