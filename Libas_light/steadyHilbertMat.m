% hilbert transform and display/saving of envelope function[demodmat, phasemat, complexmat]=steadyHilbertMat(matrix, targetfreq, bslvec, filterorder, plotflag, SampRate);if nargin < 5, plotflag=0; endif nargin < 4, filterorder=8; endif nargin < 3, bslvec = 50:80; end    [AvgMat] = matrix;        if ~isempty(bslvec)    AvgMat = bslcorr(AvgMat, bslvec);    else    AvgMat = AvgMat;    end        % calculate time axis		taxis = 0:1000/SampRate:size(AvgMat,2)*1000/SampRate - 1000/SampRate;	taxis = taxis/1000;     	M2 = 30;    	squarecos1 = (cos(pi/2:(pi-pi/2)/M2:pi-(pi-pi/2)/M2)).^2;		squarecosfunction = [squarecos1 ones(1,length(taxis)-length(squarecos1).*2) fliplr(squarecos1)];        mat4mul = repmat(squarecosfunction, size(AvgMat,1), 1);                 AvgMat = AvgMat.*mat4mul;	    %design two filters around targetfreq and filter accordingly    uppercutoffHz = targetfreq + .5;     lowercutoffHz = targetfreq - .5;         [Blow,Alow] = butter(filterorder, uppercutoffHz/(SampRate/2));          [Bhigh,Ahigh] = butter(filterorder, lowercutoffHz/(SampRate/2), 'high'); 		% flip AvgMat and filter over all channels    AvgMat = AvgMat';         % filter now     lowpasssig = filtfilt(Blow,Alow, AvgMat);      lowhighpasssig = filtfilt(Bhigh, Ahigh, lowpasssig);          % calculate hilbert transform     tempmat = hilbert(lowhighpasssig);          % flip back to avoid confusion; now channels are rows again    tempmat = tempmat';        % plot if plotflag on      if plotflag    figure(10)      plot(taxis, lowhighpasssig(:,14)), hold on, plot(taxis, imag(tempmat(14,:)), 'r'), plot(taxis, abs(tempmat(14,:)), 'k')    pause(.5)     end          hold off     demodmat = abs(tempmat);  phasemat = angle(tempmat); complexmat = tempmat; 	%	[File,Path,FilePath]=SaveAvgFile([atgPath '.hamp' num2str(round(targetfreq))],demodmat,NTrialAvgVec,StdChanTimeMat, SampRate);   % [File,Path,FilePath]=SaveAvgFile([atgPath '.hphas'],phasemat,NTrialAvgVec,StdChanTimeMat, SampRate);    %eval(['save ' deblank(atgPath) '.pha phasemat -ascii'])