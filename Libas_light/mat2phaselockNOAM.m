function[PLImat1]=mat2phaselockNOAM(matfilemat, confilemat, refsensor, SampRate, plotflag);% reads EEG.data array previously stored to disk as a mat file with 3-d% elcs time trials, averages for conditions it finds in text file with% condition information (3 conditions) does phase locking, and saves as atg filesfor index = 1:size(matfilemat,1);         confilepath = deblank(confilemat(index,:));         if ~isstruct(matfilemat);         atgPath = deblank(matfilemat(index,:));    else        atgPath = matfilemat(index).name;     end	  a = load(atgPath);   EEGdata3d = double(a.datamat);  conditions = load(confilepath);      % assemble trials for pleasant, neutral, unpleasant           submatpleasant = EEGdata3d(:,:,find(conditions==1));       submatneutral = EEGdata3d(:,:,find(conditions ==2));       submatunpleasant = EEGdata3d(:,:,find(conditions==3));            % pleasant       for x = 1:size(submatpleasant, 3)      [demodmat, phasemat, tempmat]=steadyHilbertMat(submatpleasant(:, :, x), 7.5, 10:100, 10,plotflag, SampRate);      tempmat = tempmat./abs(tempmat);       tempmatdiff = tempmat - repmat(tempmat(refsensor,:), size(EEGdata3d,1), 1);      tempmatdiff(refsensor,:) = 1;       tempmatdiff = tempmatdiff./abs(tempmatdiff);                             if x ==1, summat1 = tempmatdiff; else summat1=summat1+tempmatdiff; end       end       PLImat1 = abs(summat1./size(EEGdata3d,3));        PLImat1(refsensor, :) = mean(PLImat1, 1);               [File,Path,FilePath]=SaveAvgFile([atgPath '.PLI.at1.' num2str(refsensor) '.ar' ],PLImat1,[],[], SampRate);              % neutral       for x = 1:size(submatneutral, 3)      [demodmat, phasemat, tempmat]=steadyHilbertMat(submatneutral(:, :, x), 7.5, 10:100, 10, plotflag, SampRate);      tempmat = tempmat./abs(tempmat);       tempmatdiff = tempmat - repmat(tempmat(refsensor,:), size(EEGdata3d,1), 1);      tempmatdiff(refsensor,:) = 1;       tempmatdiff = tempmatdiff./abs(tempmatdiff);                             if x ==1, summat1 = tempmatdiff; else summat1=summat1+tempmatdiff; end       end       PLImat1 = abs(summat1./size(EEGdata3d,3));        PLImat1(refsensor, :) = mean(PLImat1, 1);               [File,Path,FilePath]=SaveAvgFile([atgPath '.PLI.at2.' num2str(refsensor) '.ar' ],PLImat1,[],[], SampRate);                % unpleasant       for x = 1:size(submatunpleasant, 3)      [demodmat, phasemat, tempmat]=steadyHilbertMat(submatunpleasant(:, :, x), 7.5, 10:100, 10, plotflag, SampRate);      tempmat = tempmat./abs(tempmat);       tempmatdiff = tempmat - repmat(tempmat(refsensor,:), size(EEGdata3d,1), 1);      tempmatdiff(refsensor,:) = 1;       tempmatdiff = tempmatdiff./abs(tempmatdiff);                             if x ==1, summat1 = tempmatdiff; else summat1=summat1+tempmatdiff; end       end       PLImat1 = abs(summat1./size(EEGdata3d,3));        PLImat1(refsensor, :) = mean(PLImat1, 1);               [File,Path,FilePath]=SaveAvgFile([atgPath '.PLI.at3.' num2str(refsensor) '.ar' ],PLImat1,[],[], SampRate);        end