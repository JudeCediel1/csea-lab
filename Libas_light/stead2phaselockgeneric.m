%==================================================================%%	stead2phaselock%% sliding window procedure%%%	%	Function definition function [fftamp, fftcomplexphasevec, phasestabmat, phaselocksens, tempdiff] = stead2phaselockgeneric(filemat, plotflag, bslvec, ssvepvec,foi,samprate, refsensor);    if nargin < 2, plotflag = [], end  % this to be done outside the loop to save time, needed for winshift proc sampcycle=1000/samprate; %added code this is just the sample interval tempvec = round((1000/foi)/sampcycle); % duration of 1 cycle in sample points; this makes sure that average win duration is exactly @@, which is the duration in sp of one cyle at @@ Hz = @@ ms longvec = repmat(tempvec,1,200); % repeat this many times, at least for duration of entire epoch, subsegments are created later  winshiftvec_long = cumsum(longvec)+ ssvepvec(1); % use cumsum function to create growing vector of indices for start of the winshift tempindexvec = find(winshiftvec_long > ssvepvec(length(ssvepvec)));   endindex = tempindexvec(1);  % this is the first index for which the winshiftvector exceeds the data segment  winshiftvec = winshiftvec_long(1:endindex-5); shiftcycle=round(tempvec*4);    % duration of 4 cycles in sample points   samp=1000/samprate;        freqres = 1000/(shiftcycle*samp); %added code to find the appropriate bin for the frequency of interest for each segment        freqbins = 0:freqres:(samprate/2);        Tolerance=0.1;        targetbin=find(abs(freqbins-foi)<Tolerance);    for fileindex = 1 : size(filemat,1);        fftamp = [];     fftcomplexphasevec = [];     	FilePath = deblank(filemat(fileindex,:));   			[rawmat,File,Path,FilePath,NTrialAvgVec,StdChanTimeMat,...		SampRate,AvgRef,Version,MedMedRawVec,MedMedAvgVec,EegMegStatus,NChanExtra]= ReadAvgFile(FilePath);		%============================================================	% 2. Baseline correction	%===========================================================		disp ('subtracting baseline')	    datamat = bslcorr(rawmat, bslvec);    size(datamat)	%===========================================================	% 3. moving window procedure with 4 cycles @ 12 Hz !!!	% 	%===========================================================	disp('moving window procedure')		winmatsum = zeros(size(datamat,1),shiftcycle); %4 cycles		if plotflag, h = figure, end       for winshiftstep = 1:length(winshiftvec)		        winmatsum = (winmatsum + regressionMAT(datamat(:,[winshiftvec(winshiftstep):winshiftvec(winshiftstep)+(shiftcycle-1)]))); % time domain averaging for win file                %calculate complex fft on segment        trialmat = regressionMAT(datamat(:,[winshiftvec(winshiftstep):winshiftvec(winshiftstep)+(shiftcycle-1)]));          % amplitude for each segment       NFFT = shiftcycle-1;        NumUniquePts = ceil((NFFT+1)/2); 	   fftmat = fft(trialmat(:,1:(shiftcycle-1))'); % transpose: channels as columns (fft columnwise)       Mag = abs(fftmat);                                                   % Amplitude calc       Mag = Mag*2;   	        Mag(1) = Mag(1)/2;                                                    % DC was unique        if ~rem(NFFT,2),                                                    % Nyquist Frequency unique            Mag(length(Mag))=Mag(length(Mag))/2;        end        Mag=Mag/NFFT; % scale fft so it is independent of NFFT                            fftamp = [fftamp; Mag((targetbin),:)];                  % phase for each segment @ 12 Hz    fftcomplexphasevec = [fftcomplexphasevec; fftmat((targetbin),:)];                           if plotflag           subplot(2,1,2), plot(1:sampcycle:shiftcycle*samp, regressionMAT(datamat(:,[winshiftvec(winshiftstep):winshiftvec(winshiftstep)+(shiftcycle-1)]))'), title(['sliding window starting at ' num2str((winshiftvec(winshiftstep))*sampcycle)  ' ms ']), xlabel('time in milliseconds')           subplot(2,1,1), plot(1:sampcycle:shiftcycle*samp, winmatsum'), title(['sum of sliding windows; number of shifts:' num2str(winshiftstep) ]), ylabel('microvolts')          %    subplot(3,1,3), hold on, circle([0,0],1,200,'-');          %    plot([0;(imag(fouriercomp(120)./tenHZampfft(120)))], [0;(real(fouriercomp(120)./tenHZampfft(120)))]);title('phase angle of window')            pause(.4)       end          %    movmat(index) = getframe(h)     end        winmat = winmatsum./length(winshiftvec);	%===========================================================	% 5. determine amplitude and Phase using fft of the winmat (i.e. the	% average	%===========================================================	disp ('determining 12 Hz Phase per channel')		% FFT of the average winmat	% 		NFFT = shiftcycle-1; %one cycle in sp of the desired frequency times 4 oscillations (-1)	NumUniquePts = ceil((NFFT+1)/2); 	fftMat = fft (winmat', (shiftcycle-1));  % transpose: channels as columns (fft columnwise)	Mag = abs(fftMat);                                                   % Amplitude berechnen	Mag = Mag*2;   		Mag(1) = Mag(1)/2;                                                    % DC trat aber nicht doppelt auf	if ~rem(NFFT,2),                                                    % Nyquist Frequenz (falls vorhanden) auch nicht doppelt        Mag(length(Mag))=Mag(length(Mag))/2;	end		Mag=Mag/NFFT;                                                         % FFT so skalieren, da? sie keine Funktion von NFFT ist    	% 	% 	%===========================================================% 	% 6. determine phaselocking and write out results% 	%===========================================================% 	% amplitudefftamp = fftamp'; %SaveAvgFile([FilePath '.tvamp' ],fftamp,[],[],SampRate,[],[],EegMegStatus)% phase stabilityfftcomplexphasevec = fftcomplexphasevec'; fftcomplexphasevec_norm = fftcomplexphasevec./abs(fftcomplexphasevec); phasestabmat = abs(mean(fftcomplexphasevec_norm, 2)); % intersite phaselocking with refsensorsize(fftcomplexphasevec_norm)tempdiff = fftcomplexphasevec_norm - repmat(fftcomplexphasevec_norm(refsensor,:), size(rawmat,1),1);tempdiff = tempdiff ./(abs(tempdiff));phaselocksens = abs(mean(tempdiff, 2));phaselocksens(refsensor,:) = mean(phaselocksens(~isnan(phaselocksens), 1));ampmat = fftamp'; % 	Phasevec = Phasevec';% 	tenHZampfft = tenHZampfft';% 	%	SaveAvgFile([FilePath '.pli' num2str(refsensor)],phaselocksens,[],[],SampRate,[],[],EegMegStatus)%          %	SaveAvgFile([FilePath '.win' ],winmat,NTrialAvgVec,[],SampRate,MedMedRawVec,MedMedAvgVec,EegMegStatus)%         %	SaveAvgFile([FilePath '.phastab' ],phasestabmat,NTrialAvgVec,[],SampRate,MedMedRawVec,MedMedAvgVec,EegMegStatus)        SaveAvgFile([FilePath '.winamp' ],ampmat,NTrialAvgVec,[],SampRate,MedMedRawVec,MedMedAvgVec,EegMegStatus)end